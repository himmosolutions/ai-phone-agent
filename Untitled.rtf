import express from "express";
import http from "http";
import { WebSocketServer } from "ws";
import twilio from "twilio";
import dotenv from "dotenv";
import WebSocket from "ws";

dotenv.config();

const app = express();
app.use(express.urlencoded({ extended: false }));
app.use(express.json());

const PORT = process.env.PORT || 3000;
const PUBLIC_BASE_URL = process.env.PUBLIC_BASE_URL;
const OPENAI_API_KEY = process.env.OPENAI_API_KEY;

if (!PUBLIC_BASE_URL || !OPENAI_API_KEY) {
  throw new Error("Missing PUBLIC_BASE_URL or OPENAI_API_KEY");
}

/**
 * Incoming call webhook
 */
app.post("/incoming-call", (req, res) => {
  const VoiceResponse = twilio.twiml.VoiceResponse;
  const twiml = new VoiceResponse();

  twiml.say(
    { voice: "alice" },
    "Hello. Please hold while I connect you to our automated assistant."
  );

  const start = twiml.start();
  start.stream({
    url: `${PUBLIC_BASE_URL.replace("https://", "wss://")}/twilio-stream`,
  });

  twiml.pause({ length: 60 });

  res.type("text/xml");
  res.send(twiml.toString());
});

const server = http.createServer(app);

const wss = new WebSocketServer({
  server,
  path: "/twilio-stream",
});

wss.on("connection", (twilioWs) => {
  console.log("Twilio Media Stream connected");

  const openaiWs = new WebSocket(
    "
